{"ast":null,"code":"import _objectSpread from\"/Users/todoporunalma/Desktop/Corporacion/coptua_react/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useMemo,useCallback}from\"react\";import DashboardLayout from\"../../components/layout/DashboardLayout\";import{dbService}from\"../../services/database\";import useDebouncedSearch from\"../../hooks/useDebouncedSearch\";import LoadingSpinner from\"../../components/Common/LoadingSpinner\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Finance=()=>{const[mensualidades,setMensualidades]=useState([]);const[participants,setParticipants]=useState([]);const[sedes,setSedes]=useState([]);const[error,setError]=useState(null);const[loading,setLoading]=useState(true);const[currentPage,setCurrentPage]=useState(1);const[itemsPerPage]=useState(10);const[searchTerm,setSearchTerm]=useState('');const[filtros,setFiltros]=useState({month:'all',sede:'all',year:'all'});const[debouncedSearch]=useDebouncedSearch(searchTerm);const[showModal,setShowModal]=useState(false);const[editingId,setEditingId]=useState(null);const[formData,setFormData]=useState({participant_id:'',mes:'',año:new Date().getFullYear(),valor:'',status:'PAGADO'});const months=useMemo(()=>[{value:1,label:'Enero'},{value:2,label:'Febrero'},{value:3,label:'Marzo'},{value:4,label:'Abril'},{value:5,label:'Mayo'},{value:6,label:'Junio'},{value:7,label:'Julio'},{value:8,label:'Agosto'},{value:9,label:'Septiembre'},{value:10,label:'Octubre'},{value:11,label:'Noviembre'},{value:12,label:'Diciembre'}],[]);const years=Array.from({length:11},(_,i)=>2020+i);const getMonthLabel=useCallback(mes=>{const month=months.find(m=>m.value===mes);return month?month.label:mes.toString();},[months]);const getToggleStatus=status=>{return status==='PAGADO'?'PENDIENTE':'PAGADO';};const getStatusClass=status=>{if(status==='PAGADO'){return'bg-green-100 text-green-800 hover:bg-green-200';}else if(status==='VENCIDA'){return'bg-orange-100 text-orange-800 hover:bg-orange-200';}return'bg-red-100 text-red-800 hover:bg-red-200';};const getButtonTitle=status=>{return status==='PAGADO'?'Cambiar a Pendiente':'Cambiar a Pagado';};useEffect(()=>{const loadData=async()=>{try{setLoading(true);setError(null);console.log('🔄 Cargando datos financieros...');const[mensRes,partsRes,sedesRes]=await Promise.all([dbService.getMensualidades(),dbService.getParticipantes(),dbService.getSedes()]);console.log('📊 Resultados:',{mensRes,partsRes,sedesRes});// Asegurar que siempre sean arrays\nconst mensualidadesData=Array.isArray(mensRes.data)?mensRes.data:[];const participantesData=Array.isArray(partsRes.data)?partsRes.data:[];const sedesData=Array.isArray(sedesRes.data)?sedesRes.data:[];setMensualidades(mensualidadesData);setParticipants(participantesData);setSedes(sedesData);console.log('✅ Datos cargados:',{mensualidades:mensualidadesData.length,participantes:participantesData.length,sedes:sedesData.length});}catch(err){console.error('❌ Error cargando datos financieros:',err);setError(err.message||'Error desconocido al cargar datos');// Asegurar arrays vacíos en caso de error\nsetMensualidades([]);setParticipants([]);setSedes([]);}finally{setLoading(false);}};loadData();},[]);const filteredMensualidades=useMemo(()=>{// Asegurar que mensualidades siempre sea un array\nconst safeMensualidades=Array.isArray(mensualidades)?mensualidades:[];let filtered=safeMensualidades;if(filtros.month!=='all'){filtered=filtered.filter(m=>m.mes===parseInt(filtros.month));}if(filtros.sede!=='all'){filtered=filtered.filter(m=>m.sede_id===parseInt(filtros.sede));}if(filtros.year!=='all'){filtered=filtered.filter(m=>m.año===parseInt(filtros.year));}if(debouncedSearch){filtered=filtered.filter(m=>(m.participant_name||'').toLowerCase().includes(debouncedSearch.toLowerCase())||getMonthLabel(m.mes).toLowerCase().includes(debouncedSearch.toLowerCase()));}return filtered;},[mensualidades,filtros,debouncedSearch,getMonthLabel]);const paginatedMensualidades=useMemo(()=>{const indexOfLastItem=currentPage*itemsPerPage;const indexOfFirstItem=indexOfLastItem-itemsPerPage;return filteredMensualidades.slice(indexOfFirstItem,indexOfLastItem);},[filteredMensualidades,currentPage,itemsPerPage]);const totalPages=Math.ceil(filteredMensualidades.length/itemsPerPage);const handlePageChange=page=>{setCurrentPage(page);};const handleFilterChange=newFiltros=>{setFiltros(newFiltros);setCurrentPage(1);};const openModal=function(type){let id=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(id){// Pre-fill form with existing data\nconst mensualidad=mensualidades.find(m=>m.id===id);if(mensualidad){setFormData({participant_id:mensualidad.participante_id,mes:mensualidad.mes,año:mensualidad.año,valor:mensualidad.valor,status:mensualidad.estado// Use original estado\n});}}else{setFormData({participant_id:'',mes:'',año:new Date().getFullYear(),valor:'',status:'PAGADO'});}setEditingId(id);setShowModal(true);};const toggleStatus=async(id,newStatus)=>{try{await dbService.updateMensualidad(id,{estado:newStatus});// Refresh data\nconst{data}=await dbService.getMensualidades();setMensualidades(data);}catch(err){console.error('Error updating status:',err);// Optionally show error toast\n}};const handleSubmit=async e=>{e.preventDefault();const submitData={participant_id:parseInt(formData.participant_id),mes:parseInt(formData.mes),año:parseInt(formData.año),valor:parseInt(formData.valor),status:formData.status};try{if(editingId){await dbService.updateMensualidad(editingId,submitData);}else{await dbService.createMensualidad(submitData);}setShowModal(false);setEditingId(null);const{data}=await dbService.getMensualidades();setMensualidades(data);}catch(err){console.error('Error saving payment:',err);}};if(loading){return/*#__PURE__*/_jsx(DashboardLayout,{title:\"Mensualidades\",subtitle:\"Cargando mensualidades...\",loading:true,children:/*#__PURE__*/_jsx(LoadingSpinner,{})});}if(error){return/*#__PURE__*/_jsx(DashboardLayout,{title:\"Mensualidades\",subtitle:\"Error al cargar datos\",loading:false,children:/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center h-screen\",children:/*#__PURE__*/_jsx(\"div\",{className:\"bg-red-50 border border-red-200 rounded-lg p-4\",children:/*#__PURE__*/_jsxs(\"p\",{className:\"text-red-600\",children:[\"Error loading payments: \",error]})})})});}return/*#__PURE__*/_jsxs(DashboardLayout,{title:\"Mensualidades\",subtitle:\"Pagadas, pendientes y vencidas\",extraActions:/*#__PURE__*/_jsxs(\"button\",{onClick:()=>openModal('add'),className:\"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors\",children:[/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-plus mr-2\"}),\"Nueva Mensualidad\"]}),children:[/*#__PURE__*/_jsxs(\"section\",{className:\"px-6 py-6\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"bg-white shadow-sm border-b border-gray-200 px-6 py-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 md:grid-cols-4 gap-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-sm font-medium text-gray-700 mb-1\",children:\"Mes\"}),/*#__PURE__*/_jsxs(\"select\",{value:filtros.month,onChange:e=>handleFilterChange(_objectSpread(_objectSpread({},filtros),{},{month:e.target.value})),className:\"w-full border border-gray-300 rounded-md px-3 py-2\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"all\",children:\"Todos\"}),months.map(m=>/*#__PURE__*/_jsx(\"option\",{value:m.value,children:m.label},m.value))]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-sm font-medium text-gray-700 mb-1\",children:\"Sede\"}),/*#__PURE__*/_jsxs(\"select\",{value:filtros.sede,onChange:e=>handleFilterChange(_objectSpread(_objectSpread({},filtros),{},{sede:e.target.value})),className:\"w-full border border-gray-300 rounded-md px-3 py-2\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"all\",children:\"Todas\"}),sedes.map(s=>/*#__PURE__*/_jsx(\"option\",{value:s.id,children:s.nombre},s.id))]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-sm font-medium text-gray-700 mb-1\",children:\"A\\xF1o\"}),/*#__PURE__*/_jsxs(\"select\",{value:filtros.year,onChange:e=>handleFilterChange(_objectSpread(_objectSpread({},filtros),{},{year:e.target.value})),className:\"w-full border border-gray-300 rounded-md px-3 py-2\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"all\",children:\"Todos\"}),years.map(y=>/*#__PURE__*/_jsx(\"option\",{value:y,children:y},y))]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-sm font-medium text-gray-700 mb-1\",children:\"B\\xFAsqueda\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:searchTerm,onChange:e=>setSearchTerm(e.target.value),placeholder:\"Buscar por nombre o mes...\",className:\"w-full border border-gray-300 rounded-md px-3 py-2\"})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-6\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"bg-white rounded-lg shadow overflow-hidden\",children:/*#__PURE__*/_jsx(\"div\",{className:\"overflow-x-auto\",children:/*#__PURE__*/_jsxs(\"table\",{className:\"min-w-full divide-y divide-gray-200\",children:[/*#__PURE__*/_jsx(\"thead\",{className:\"bg-gray-50\",children:/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsx(\"th\",{className:\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\",children:\"Participante\"}),/*#__PURE__*/_jsx(\"th\",{className:\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\",children:\"Mes\"}),/*#__PURE__*/_jsx(\"th\",{className:\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\",children:\"Cantidad\"}),/*#__PURE__*/_jsx(\"th\",{className:\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\",children:\"Estado\"}),/*#__PURE__*/_jsx(\"th\",{className:\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\",children:\"Fecha\"}),/*#__PURE__*/_jsx(\"th\",{className:\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\",children:\"Acciones\"})]})}),/*#__PURE__*/_jsx(\"tbody\",{className:\"bg-white divide-y divide-gray-200\",children:loading?/*#__PURE__*/_jsx(\"tr\",{children:/*#__PURE__*/_jsx(\"td\",{colSpan:\"6\",className:\"px-6 py-4 text-center\",children:/*#__PURE__*/_jsx(LoadingSpinner,{size:\"sm\",text:\"Cargando...\"})})}):paginatedMensualidades.length===0?/*#__PURE__*/_jsx(\"tr\",{children:/*#__PURE__*/_jsx(\"td\",{colSpan:\"6\",className:\"px-6 py-4 text-center text-gray-500\",children:\"No hay mensualidades que mostrar\"})}):paginatedMensualidades.map(row=>{var _row$valor;return/*#__PURE__*/_jsxs(\"tr\",{className:\"hover:bg-gray-50\",children:[/*#__PURE__*/_jsx(\"td\",{className:\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\",children:row.participant_name}),/*#__PURE__*/_jsx(\"td\",{className:\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\",children:getMonthLabel(row.mes)}),/*#__PURE__*/_jsxs(\"td\",{className:\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\",children:[\"$\",((_row$valor=row.valor)===null||_row$valor===void 0?void 0:_row$valor.toLocaleString())||'0']}),/*#__PURE__*/_jsx(\"td\",{className:\"px-6 py-4 whitespace-nowrap\",children:/*#__PURE__*/_jsx(\"button\",{onClick:()=>toggleStatus(row.id,getToggleStatus(row.status)),className:\"inline-flex px-3 py-1 text-xs font-semibold rounded-full cursor-pointer transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 \".concat(getStatusClass(row.status)),title:getButtonTitle(row.status),children:row.status})}),/*#__PURE__*/_jsx(\"td\",{className:\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\",children:new Date(row.fecha_vencimiento).toLocaleDateString()}),/*#__PURE__*/_jsx(\"td\",{className:\"px-6 py-4 whitespace-nowrap text-sm font-medium\",children:/*#__PURE__*/_jsx(\"div\",{className:\"flex space-x-2\",children:/*#__PURE__*/_jsx(\"button\",{onClick:()=>openModal('edit',row.id),className:\"text-blue-600 hover:text-blue-900 transition-colors\",children:/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-edit\"})})})})]},row.id);})})]})})}),totalPages>1&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-white rounded-2xl shadow-lg border border-gray-100 p-4 mt-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-sm text-gray-700\",children:[\"Mostrando \",(currentPage-1)*itemsPerPage+1,\" a \",Math.min(currentPage*itemsPerPage,filteredMensualidades.length),\" de \",filteredMensualidades.length,\" resultados\"]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-2\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>handlePageChange(currentPage-1),disabled:currentPage===1,className:\"px-3 py-1 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\",children:\"Anterior\"}),Array.from({length:totalPages},(_,i)=>i+1).map(page=>/*#__PURE__*/_jsx(\"button\",{onClick:()=>handlePageChange(page),className:\"px-3 py-1 text-sm font-medium rounded-md \".concat(page===currentPage?'bg-blue-600 text-white':'text-gray-500 bg-white border border-gray-300 hover:bg-gray-50'),children:page},page)),/*#__PURE__*/_jsx(\"button\",{onClick:()=>handlePageChange(currentPage+1),disabled:currentPage===totalPages,className:\"px-3 py-1 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\",children:\"Siguiente\"})]})]})})]})]}),showModal&&/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\",children:/*#__PURE__*/_jsx(\"div\",{className:\"bg-white rounded-xl shadow-2xl max-w-md w-full mx-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"p-6\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-semibold text-gray-800 mb-4\",children:editingId?'Editar Mensualidad':'Nueva Mensualidad'}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit,className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"select\",{value:formData.participant_id,onChange:e=>setFormData(_objectSpread(_objectSpread({},formData),{},{participant_id:e.target.value})),className:\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\",required:true,children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"Seleccionar Participante\"}),participants.map(p=>/*#__PURE__*/_jsxs(\"option\",{value:p.id,children:[p.nombres,\" \",p.apellidos,\" - \",p.documento]},p.id))]}),/*#__PURE__*/_jsxs(\"select\",{value:formData.mes,onChange:e=>setFormData(_objectSpread(_objectSpread({},formData),{},{mes:e.target.value})),className:\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\",required:true,children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"Seleccionar Mes\"}),months.map(m=>/*#__PURE__*/_jsx(\"option\",{value:m.value,children:m.label},m.value))]}),/*#__PURE__*/_jsx(\"select\",{value:formData.año,onChange:e=>setFormData(_objectSpread(_objectSpread({},formData),{},{año:e.target.value})),className:\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\",required:true,children:years.map(y=>/*#__PURE__*/_jsx(\"option\",{value:y,children:y},y))}),/*#__PURE__*/_jsx(\"input\",{type:\"number\",placeholder:\"Valor\",value:formData.valor,onChange:e=>setFormData(_objectSpread(_objectSpread({},formData),{},{valor:e.target.value})),className:\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\",required:true}),/*#__PURE__*/_jsxs(\"select\",{value:formData.status,onChange:e=>setFormData(_objectSpread(_objectSpread({},formData),{},{status:e.target.value})),className:\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"PAGADO\",children:\"Pagado\"}),/*#__PURE__*/_jsx(\"option\",{value:\"PENDIENTE\",children:\"Pendiente\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end space-x-3\",children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>setShowModal(false),className:\"px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200\",children:\"Cancelar\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\",children:\"Guardar\"})]})]})]})})})]});};export default Finance;","map":null,"metadata":{},"sourceType":"module"}